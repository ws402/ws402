
// complete-express-server.js
// Complete example of WS402 integration with Express

const express = require('express');
const http = require('http');
const WebSocket = require('ws');
const path = require('path');
const { WS402, MockPaymentProvider } = require('ws402');

// ===== 1. SETUP EXPRESS APP =====
const app = express();
app.use(express.json());
app.use(express.static('public'));

// ===== 2. CREATE HTTP & WEBSOCKET SERVERS =====
const server = http.createServer(app);
const wss = new WebSocket.Server({ 
  server,
  path: '/ws402' // WebSocket endpoint will be ws://localhost:3000/ws402
});

// ===== 3. INITIALIZE PAYMENT PROVIDER =====
// In production, replace with BasePaymentProvider
const paymentProvider = new MockPaymentProvider();

// ===== 4. INITIALIZE WS402 =====
const ws402 = new WS402(
  {
    // Pricing configuration
    pricePerSecond: 10,           // 10 wei per second
    currency: 'wei',
    maxSessionDuration: 600,      // Max 10 minutes per session
    
    // Update frequency
    updateInterval: 3000,         // Send updates every 3 seconds
    
    // User ID extraction from WebSocket request
    userIdExtractor: (req) => {
      const url = new URL(req.url, `http://${req.headers.host}`);
      return url.searchParams.get('userId') || 'anonymous';
    },
    
    // Callbacks for monitoring
    onPaymentVerified: (session) => {
      console.log(`âœ… Payment verified for user: ${session.userId}`);
      console.log(`   Session ID: ${session.sessionId}`);
      console.log(`   Paid amount: ${session.paidAmount}`);
    },
    
    onRefundIssued: (session, refund) => {
      console.log(`ðŸ’° Refund issued to user: ${session.userId}`);
      console.log(`   Amount: ${refund.amount}`);
      console.log(`   Reason: ${refund.reason}`);
    },
    
    onSessionEnd: (session) => {
      console.log(`ðŸ”š Session ended: ${session.sessionId}`);
      console.log(`   Duration: ${session.elapsedSeconds}s`);
      console.log(`   Consumed: ${session.consumedAmount}`);
      console.log(`   Bytes: ${session.bytesTransferred}`);
    },
  },
  paymentProvider
);

// ===== 5. ATTACH WS402 TO WEBSOCKET SERVER =====
// This makes WS402 handle all WebSocket connections automatically
ws402.attach(wss);

// ===== 6. HTTP ROUTES =====

// Route 1: Get WS402 schema for a resource
// Client calls this BEFORE connecting to WebSocket
app.get('/api/resource/:resourceId/schema', (req, res) => {
  try {
    const resourceId = req.params.resourceId;
    const duration = parseInt(req.query.duration) || 300; // Default 5 minutes
    
    // Generate WS402 schema
    const schema = ws402.generateSchema(resourceId, duration);
    
    // Add WebSocket endpoint to schema
    schema.websocketEndpoint = `ws://${req.headers.host}/ws402?resourceId=${resourceId}`;
    
    res.json(schema);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Route 2: Check if a resource requires payment
app.get('/api/resource/:resourceId', (req, res) => {
  const resourceId = req.params.resourceId;
  
  // Check if resource requires WS402 payment
  const requiresPayment = true; // Your logic here
  
  if (requiresPayment) {
    // Return 402 Payment Required with WS402 schema
    const schema = ws402.generateSchema(resourceId, 300);
    schema.websocketEndpoint = `ws://${req.headers.host}/ws402?resourceId=${resourceId}`;
    
    res.status(402).json({
      error: 'Payment Required',
      protocol: 'ws402',
      schema: schema
    });
  } else {
    // Return resource directly
    res.json({ resource: 'your-data' });
  }
});

// Route 3: Get active sessions (admin/monitoring)
app.get('/api/admin/sessions', (req, res) => {
  const sessions = ws402.getActiveSessions();
  
  res.json({
    count: sessions.length,
    sessions: sessions.map(s => ({
      sessionId: s.sessionId,
      userId: s.userId,
      elapsedSeconds: s.elapsedSeconds,
      consumedAmount: s.consumedAmount,
      remainingBalance: s.paidAmount - s.consumedAmount,
      bytesTransferred: s.bytesTransferred,
      messageCount: s.messageCount,
      status: s.status,
    }))
  });
});

// Route 4: Get specific user session
app.get('/api/admin/sessions/user/:userId', (req, res) => {
  const session = ws402.getSessionByUserId(req.params.userId);
  
  if (!session) {
    return res.status(404).json({ error: 'Session not found' });
  }
  
  res.json({
    sessionId: session.sessionId,
    userId: session.userId,
    elapsedSeconds: session.elapsedSeconds,
    consumedAmount: session.consumedAmount,
    remainingBalance: session.paidAmount - session.consumedAmount,
  });
});

// Route 5: Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok',
    activeSessions: ws402.getActiveSessions().length,
    timestamp: Date.now(),
  });
});

// ===== 7. EVENT LISTENERS =====
// Listen to WS402 events for logging/monitoring

ws402.on('session_end', (session) => {
  // Log to database, analytics, etc.
  console.log('Session analytics:', {
    userId: session.userId,
    duration: session.elapsedSeconds,
    revenue: session.consumedAmount,
  });
});

ws402.on('refund', ({ session, refund }) => {
  // Log refund for accounting
  console.log('Refund processed:', refund);
});

ws402.on('error', (error) => {
  // Log errors
  console.error('WS402 Error:', error);
});

// ===== 8. ERROR HANDLING =====
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Internal server error' });
});

// ===== 9. START SERVER =====
const PORT = process.env.PORT || 3000;

server.listen(PORT, () => {
  console.log('=================================');
  console.log('ðŸš€ WS402 Server Running');
  console.log('=================================');
  console.log(`HTTP Server: http://localhost:${PORT}`);
  console.log(`WebSocket: ws://localhost:${PORT}/ws402`);
  console.log('');
  console.log('ðŸ“ Endpoints:');
  console.log(`  GET /api/resource/:id/schema - Get WS402 schema`);
  console.log(`  GET /api/resource/:id - Request resource`);
  console.log(`  GET /api/admin/sessions - View active sessions`);
  console.log(`  GET /health - Health check`);
  console.log('');
  console.log('ðŸ§ª Test:');
  console.log(`  curl http://localhost:${PORT}/api/resource/video-123/schema`);
  console.log(`  wscat -c "ws://localhost:${PORT}/ws402?userId=alice"`);
  console.log('=================================');
});

// ===== 10. GRACEFUL SHUTDOWN =====
process.on('SIGTERM', () => {
  console.log('SIGTERM received, closing server...');
  server.close(() => {
    console.log('Server closed');
    process.exit(0);
  });
});